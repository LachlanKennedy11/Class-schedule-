<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counselor Course Selection Portal</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom styles for professional look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 10vh;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom: 3px solid #3b82f6;
            background-color: #ffffff;
            color: #1d4ed8;
            font-weight: 600;
        }
        .tabcontent {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Custom Modal Styling to replace alert() */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        /* Standard Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        /* Blue Spinner for plan generation */
        .loading-spinner-blue {
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Specific styling for the 4-Year Plan content */
        #four-year-plan-content h1, #four-year-plan-content h2, #four-year-plan-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        #four-year-plan-content h2 { font-size: 1.5rem; color: #1e40af; }
        #four-year-plan-content h3 { font-size: 1.25rem; color: #3b82f6; }
        #four-year-plan-content ul {
            list-style: disc;
            margin-left: 1.5rem;
            padding-left: 0;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Custom Message Box Modal (Replaces alert()) -->
    <div id="message-box" class="modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg transform transition-all duration-300 scale-95 modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-blue-600 flex items-center">
                <i class="fas fa-info-circle mr-2"></i> Information
            </h3>
            <p id="modal-body" class="text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150">
                Dismiss
            </button>
        </div>
    </div>
    
    <!-- 4-Year Plan Modal (New Feature) -->
    <div id="four-year-plan-modal" class="modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 modal-content">
            <h3 class="text-2xl font-bold mb-4 text-indigo-600 flex items-center">
                <i class="fas fa-graduation-cap mr-2"></i> Suggested 4-Year Academic Plan
            </h3>
            <p class="text-gray-600 mb-4 border-b pb-3">This plan is generated by AI based on your course selections and general graduation requirements. Please review it with your counselor!</p>
            
            <div id="four-year-plan-content" class="text-gray-800">
                <!-- Content will be injected here after generation -->
            </div>
            
            <button onclick="closeFourYearPlanModal()" class="w-full mt-6 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg transition duration-150">
                Close & Return to OCR Review
            </button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 shadow-2xl rounded-xl">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Counselor Course Selection Portal</h1>
            <p class="text-gray-600">Enter your details, then select courses either by OCR or manual entry.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-info-btn" class="tab-button active flex-1 py-3 px-1 text-center text-sm sm:text-base text-gray-600 rounded-t-lg" onclick="openTab('student-info', this)">
                <i class="fas fa-user-circle mr-2"></i> Student Info
            </button>
            <button id="tab-ocr-btn" class="tab-button flex-1 py-3 px-1 text-center text-sm sm:text-base text-gray-600 rounded-t-lg" onclick="openTab('ocr', this)">
                <i class="fas fa-camera mr-2"></i> OCR Upload & Edit
            </button>
            <button id="tab-manual-btn" class="tab-button flex-1 py-3 px-1 text-center text-sm sm:text-base text-gray-600 rounded-t-lg" onclick="openTab('manual', this)">
                <i class="fas fa-list-alt mr-2"></i> Manual Selection
            </button>
        </div>

        <!-- Student Info Content (New Default Tab) -->
        <div id="student-info" class="tabcontent" style="display: block;">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Student Details</h2>
            <div class="space-y-4 p-5 border border-green-200 rounded-lg bg-green-50">
                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Student Full Name:</label>
                    <input type="text" id="student-name" name="student_name" placeholder="John Doe" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label for="student-id" class="block text-sm font-medium text-gray-700">Student ID / Grade Level:</label>
                    <input type="text" id="student-id" name="student_id" placeholder="123456 / Grade 10" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <p class="text-sm text-gray-600 italic">
                    <i class="fas fa-info-circle mr-1"></i> Submissions will be sent to the school counselor on record.
                </p>
            </div>
            <p class="mt-4 text-sm text-gray-600">
                <i class="fas fa-check-circle text-green-500 mr-1"></i> Ensure this information is correct before moving to the next tab.
            </p>
        </div>

        <!-- OCR Content -->
        <div id="ocr" class="tabcontent">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. OCR Upload and Data Correction (Next Year's Classes)</h2>
            
            <div class="space-y-4 p-4 border border-blue-200 rounded-lg bg-blue-50">
                <label for="image-upload" class="block text-sm font-medium text-gray-700">Select Image of Course Form:</label>
                <input type="file" id="image-upload" accept="image/*" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button type="button" id="ocr-button" onclick="startOCR()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                    <i class="fas fa-magic mr-2"></i> Start OCR and Parse
                </button>
            </div>

            <!-- OCR Output -->
            <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Raw OCR Extracted Text (For Reference):</h3>
            <pre id="ocr-output" class="p-4 bg-gray-100 border border-gray-300 rounded-lg whitespace-pre-wrap text-sm text-gray-800 min-h-24">
                Upload an image and press 'Start OCR' to see the extracted raw data here...
            </pre>

            <!-- OCR Correction Fields -->
            <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Review and Correct Detected Classes:</h3>
            <p class="text-sm text-gray-600 mb-3">The AI will attempt to find classes and fill the fields below. Please review and correct as necessary.</p>

            <!-- Dynamic Input Container for OCR Results -->
            <div class="space-y-4" id="ocr-correction-container">
                <!-- Class input fields will be injected here by JavaScript after OCR runs -->
            </div>
            
            <button onclick="addClassInput('ocr')" class="mt-4 w-full py-2 px-4 border border-blue-500 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition">
                + Manually Add/Correct Class Slot
            </button>


            <button type="button" onclick="sendEmail('ocr')" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 flex items-center justify-center">
                <i class="fas fa-envelope mr-2"></i> Send Corrected OCR Data to Counselor
            </button>
        </div>

        <!-- Manual Entry Content -->
        <div id="manual" class="tabcontent">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">3. Manual Course Selection (Next Year's Classes)</h2>
            
            <!-- Schedule Preview -->
            <div class="p-5 border border-red-200 rounded-lg bg-red-50 mb-6">
                <h3 class="text-xl font-medium text-red-800 mb-3 flex items-center">
                    <i class="fas fa-calendar-alt mr-2"></i> Current Selections Preview
                </h3>
                <div class="overflow-x-auto">
                    <!-- Dynamic Input Container for Manual Selections -->
                    <div class="space-y-4" id="manual-selection-container">
                        <!-- Class input fields will be pre-populated by JavaScript -->
                    </div>
                </div>
            </div>

            <button onclick="addClassInput('manual')" class="w-full py-2 px-4 border border-blue-500 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition mb-4">
                + Add Class Slot
            </button>
            
            <button type="button" onclick="sendEmail('manual')" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 flex items-center justify-center">
                <i class="fas fa-paper-plane mr-2"></i> Submit Manual Data
            </button>
        </div>
        
        <!-- Email Preview Section -->
        <div class="mt-10 p-5 border-t-4 border-l-4 border-gray-300 rounded-lg bg-yellow-50 shadow-inner">
            <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                <i class="fas fa-eye mr-2"></i> Submission Preview (What will be sent)
            </h3>
            <pre id="email-preview-content" class="mt-2 p-3 bg-yellow-100 border border-yellow-300 rounded-md text-sm text-gray-800 min-h-20 whitespace-pre-wrap">
                Fill out the Student Info tab and then attempt a submission to see the data previewed here.
            </pre>
        </div>

    </div>

    <script>
        // --- Global Constants & Setup ---
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        
        // --- API KEY REQUIRED HERE ---
        // !!! API Key has been successfully inserted below. OCR and 4-Year Plan features are now enabled.
        const API_KEY = "AIzaSyCJHXAE1-UVqkUpJpdGIAHnyRtwPK6-Tfc"; 
        // -----------------------------
        
        const COUNSELOR_EMAIL_HARDCODED = "counselor@school.edu"; // Hardcoded email as requested

        // Mock class list for dropdowns (not used for current design, but kept for future expansion)
        const allClasses = [
            { value: "Alg1", text: "Algebra 1" },
            { value: "Eng9H", text: "English 9 Honors" },
            { value: "APChem", text: "AP Chemistry" },
            { value: "WorldHis", text: "World History" },
            { value: "SpanishI", text: "Spanish I" },
            { value: "CompSci", text: "Computer Science Intro" },
            { value: "ArtI", text: "Visual Art I" },
            { value: "PE", text: "PE/Athletics" }
        ];

        // --- Class Input Data Structure ---
        let manualClasses = JSON.parse(localStorage.getItem('manualClasses') || '[]');
        let ocrClasses = JSON.parse(localStorage.getItem('ocrClasses') || '[]');

        // --- Custom Modal Logic (Simple Message Box) ---
        function showModal(title, body) {
            document.getElementById('modal-title').innerHTML = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('message-box').classList.add('active');
        }

        function closeModal() {
            document.getElementById('message-box').classList.remove('active');
        }
        
        // --- 4-Year Plan Modal Logic ---
        function openFourYearPlanModal() {
            document.getElementById('four-year-plan-modal').classList.add('active');
        }

        function closeFourYearPlanModal() {
            document.getElementById('four-year-plan-modal').classList.remove('active');
        }
        
        // --- Validation Logic ---
        function validateStudentInfo() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            if (!name || !id) {
                showModal(
                    '<i class="fas fa-exclamation-triangle"></i> Required Information Missing', 
                    'Please go to the "Student Info" tab and fill out your full name and student ID/Grade before proceeding with a submission.'
                );
                return false;
            }
            return true;
        }

        // Function to switch between tabs
        function openTab(tabName, elm) {
            // Hide all tab content
            document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
            // Deactivate all tab buttons
            document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));

            // Show the selected tab content
            document.getElementById(tabName).style.display = "block";
            // Activate the selected tab button
            elm.classList.add("active");
            
            // Re-render class lists when switching to ensure consistency
            if (tabName === 'manual') {
                renderClassInputs('manual', manualClasses);
            } else if (tabName === 'ocr') {
                renderClassInputs('ocr', ocrClasses);
            }
        }
        
        // --- Class Input Management ---

        /** Creates a single input field for a class */
        function createClassInput(type, classData) {
            const { name, id } = classData;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'flex space-x-2 items-center';
            wrapper.dataset.id = id;

            const input = document.createElement('input');
            input.type = 'text';
            input.value = name || '';
            input.placeholder = 'e.g., AP Calculus BC or US History 101';
            input.className = 'class-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border flex-1 focus:ring-blue-500 focus:border-blue-500';
            
            // On input change, update the corresponding array (manualClasses or ocrClasses)
            input.oninput = (e) => {
                const arr = type === 'manual' ? manualClasses : ocrClasses;
                const index = arr.findIndex(c => c.id === id);
                if (index !== -1) {
                    arr[index].name = e.target.value;
                    // Persist the changes to localStorage
                    localStorage.setItem(`${type}Classes`, JSON.stringify(arr));
                }
            };

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<i class="fas fa-trash-alt text-red-500"></i>`;
            deleteButton.title = 'Remove Class Slot';
            deleteButton.className = 'p-2 rounded-full hover:bg-red-50 transition';
            deleteButton.onclick = () => removeClassInput(type, id);

            wrapper.appendChild(input);
            wrapper.appendChild(deleteButton);
            return wrapper;
        }

        /** Renders all class inputs for a given type (manual or ocr) */
        function renderClassInputs(type, classes) {
            const containerId = type === 'manual' ? 'manual-selection-container' : 'ocr-correction-container';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear existing inputs
            container.innerHTML = ''; 
            
            // Render the stored classes
            if (classes.length > 0) {
                classes.forEach(cls => {
                    container.appendChild(createClassInput(type, cls));
                });
            } else {
                // If empty, add a default slot
                addClassInput(type);
            }
        }

        /** Adds a new class input slot */
        window.addClassInput = (type, name = '') => {
            const newClass = {
                name: name,
                id: crypto.randomUUID()
            };
            
            const arr = type === 'manual' ? manualClasses : ocrClasses;
            arr.push(newClass);

            const containerId = type === 'manual' ? 'manual-selection-container' : 'ocr-correction-container';
            const container = document.getElementById(containerId);
            
            if (container) {
                container.appendChild(createClassInput(type, newClass));
                localStorage.setItem(`${type}Classes`, JSON.stringify(arr));
            }
        };

        /** Removes a class input slot */
        function removeClassInput(type, id) {
            const arr = type === 'manual' ? manualClasses : ocrClasses;
            const index = arr.findIndex(c => c.id === id);
            
            if (index !== -1) {
                arr.splice(index, 1);
                localStorage.setItem(`${type}Classes`, JSON.stringify(arr));
                renderClassInputs(type, arr); // Re-render to update the list
            }
        }


        // --- Utility Functions ---

        /** Utility to convert a File object to a Base64 string */
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    if (base64String) {
                        resolve(base64String);
                    } else {
                        reject(new Error("Failed to read file data as Base64."));
                    }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Utility for exponential backoff retry logic */
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    
                    let errorBody = {};
                    let errorMessage = `API Error: ${response.status} - ${response.statusText}`;

                    try {
                        errorBody = await response.json();
                        // Extract specific error details
                        errorMessage = errorBody.error?.message || errorMessage;
                        
                        // Check for the specific "model is overloaded" error code (429 or 'is_overloaded')
                        if (response.status === 429 || errorBody.error?.status === 'RESOURCE_EXHAUSTED' || errorMessage.includes("overloaded")) {
                            console.warn(`Attempt ${i + 1}: Model is overloaded. Retrying in ${Math.pow(2, i)}s...`);
                            if (i < retries - 1) {
                                // If overloaded, continue to the next iteration (retry)
                                const delay = Math.pow(2, i) * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue; 
                            }
                        }
                    } catch (e) { 
                        // If JSON parsing fails, we use the default status message
                        console.warn("Could not parse error body as JSON.");
                    }
                    
                    // If not successful and not recoverable (overloaded), throw the error
                    throw new Error(errorMessage);

                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- 4-Year Plan Generation Logic ---
        async function generateFourYearPlan(extractedClasses) {
            const modalBody = document.getElementById('four-year-plan-content');
            const studentName = document.getElementById('student-name').value.trim();
            
            // Attempt to extract the grade number, default to 9 if not found
            const gradeInput = document.getElementById('student-id').value.trim();
            const gradeMatch = gradeInput.match(/\d+/);
            const studentGrade = gradeMatch ? parseInt(gradeMatch[0]) : 9; 
            const targetGrade = studentGrade + 1; // Grade for the extracted classes

            modalBody.innerHTML = '<div class="flex justify-center items-center py-10"><div class="loading-spinner-blue w-8 h-8 mr-3"></div><p class="text-blue-600 font-semibold">Generating suggested 4-Year Plan...</p></div>';
            openFourYearPlanModal();

            const planPrompt = `Act as an academic counselor. The student, ${studentName}, is currently a ${studentGrade}th grader and has selected the following courses for the ${targetGrade}th grade (next year): [${extractedClasses.join(', ')}]. Based on these selections, and assuming standard US high school graduation requirements (4 English, 3-4 Math, 3-4 Science, 3 Social Studies, 2 World Language, 1 Arts, 1 PE), generate a complete, suggested 4-Year Course Plan (Grades 9, 10, 11, 12).
            
            Structure your response using markdown headings (##) for each grade level and markdown lists (ul) for the courses for maximum clarity. Do not include any introductory or concluding conversational text.`;

            const planPayload = {
                contents: [{ parts: [{ text: planPrompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a helpful and professional high school academic counselor. Provide clear, structured, and complete academic advice using Markdown format." }]
                }
            };
            const planApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
            
            try {
                const planResponse = await fetchWithRetry(planApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planPayload)
                });
                const planResult = await planResponse.json();
                const planText = planResult.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate plan. Please try again or use the manual tab.";

                // Display the result directly, relying on the model's markdown formatting
                // The custom CSS will handle the styling of the markdown elements (h2, h3, ul).
                modalBody.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap">${planText}</div>`;

            } catch (error) {
                console.error("4-Year Plan API Call Failed:", error);
                modalBody.innerHTML = `<p class="text-red-500 p-4">Error generating 4-Year Plan: ${error.message}. Please try again, or manually review your selected courses.</p>`;
            }
        }


        // --- OCR Logic using Gemini Vision Model ---
        async function startOCR() {
            if (!validateStudentInfo()) return;
            
            // Check if API key is provided, if not, show a clean error modal
            if (API_KEY === "") { 
                showModal(
                    '<i class="fas fa-key"></i> Feature Disabled', 
                    'The OCR feature requires a valid API key to call the Gemini Vision model. Please paste your key into the script block to enable this feature, or proceed to the Manual Selection tab.'
                );
                return;
            }


            const fileInput = document.getElementById('image-upload');
            const ocrOutput = document.getElementById('ocr-output');
            const ocrButton = document.getElementById('ocr-button');
            
            if (fileInput.files.length === 0) {
                showModal('<i class="fas fa-exclamation-triangle"></i> Upload Error', 'Please select an image file of the handwritten form first.');
                return;
            }

            const file = fileInput.files[0];
            const mimeType = file.type;

            if (!mimeType.startsWith('image/')) {
                 showModal('<i class="fas fa-exclamation-triangle"></i> File Type Error', `Invalid file type: ${mimeType}. Please upload a valid image file (PNG, JPG, etc.).`);
                 return;
            }

            // Show Loading State
            ocrOutput.textContent = 'Processing image... please wait. This may take a moment.';
            ocrButton.innerHTML = '<div class="loading-spinner"></div> Processing...';
            ocrButton.disabled = true;

            let base64ImageData;
            try {
                base64ImageData = await getBase64(file);
            } catch (error) {
                console.error("Base64 Conversion Failed:", error);
                ocrOutput.textContent = `ERROR: Failed to read image file. ${error.message}`;
                showModal('<i class="fas fa-times-circle"></i> File Read Failed', 'Could not read the image data. Check if the file is corrupted or too large.');
                ocrButton.innerHTML = '<i class="fas fa-magic mr-2"></i> Start OCR and Parse';
                ocrButton.disabled = false;
                return;
            }
            
            try {
                // 1. First call for raw text (for preview/reference)
                const rawTextPrompt = `Analyze the image of the student's handwritten course selection form for next year. Extract all raw, visible text for reference purposes. Do not include any formatting or conversational text.`;
                
                const rawTextPayload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: rawTextPrompt },
                                { inlineData: { mimeType: mimeType, data: base64ImageData } }
                            ]
                        }
                    ],
                };
                const rawTextApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
                
                const rawTextResponse = await fetchWithRetry(rawTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rawTextPayload)
                });
                const rawTextResult = await rawTextResponse.json();
                const rawText = rawTextResult.candidates?.[0]?.content?.parts?.[0]?.text || "No raw text extracted.";
                ocrOutput.textContent = rawText;

                // 2. Second call for structured class data
                const structuredPrompt = `Analyze the image of the student's handwritten course selection form for the NEXT ACADEMIC YEAR. Extract only the list of requested course names and/or course numbers clearly visible. Format your output strictly as a JSON array of strings. Do not include any conversational text or markdown formatting outside the JSON array.`;
                
                const structuredPayload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: structuredPrompt },
                                { inlineData: { mimeType: mimeType, data: base64ImageData } }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: { "type": "STRING" }
                        }
                    }
                };
                
                const structuredResponse = await fetchWithRetry(rawTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(structuredPayload)
                });
                
                const structuredResult = await structuredResponse.json();
                const jsonText = structuredResult.candidates?.[0]?.content?.parts?.[0]?.text;
                
                let classesArray = [];
                if (jsonText) {
                    try {
                        // The model sometimes wraps the JSON in markdown, attempt to clean it
                        const cleanJsonText = jsonText.replace(/```json|```/g, '').trim();
                        classesArray = JSON.parse(cleanJsonText);
                    } catch (e) {
                        console.error("Failed to parse AI JSON response:", e, jsonText);
                        showModal('<i class="fas fa-exclamation-triangle"></i> Parsing Error', 'AI returned data in an unexpected format. Please check the image quality and try again.');
                        return;
                    }
                }

                // Update ocrClasses array with new data
                if (Array.isArray(classesArray) && classesArray.length > 0) {
                    ocrClasses = classesArray.map(name => ({
                        name: name.trim(),
                        id: crypto.randomUUID()
                    }));
                    localStorage.setItem('ocrClasses', JSON.stringify(ocrClasses));
                    renderClassInputs('ocr', ocrClasses);
                    
                    // --- NEW: Trigger 4-Year Plan Generation and Display ---
                    await generateFourYearPlan(classesArray);
                    
                    // Show a quick success message before the large modal takes over
                    showModal('<i class="fas fa-check-circle"></i> OCR Complete', `Successfully extracted ${ocrClasses.length} classes! We've also generated a suggested 4-Year Plan for you to review.`);
                    
                } else {
                    ocrOutput.textContent += "\n\n--- STRUCTURED PARSING FAILED ---\nCould not find a structured list of classes. Please use the Manual Selection tab.";
                    showModal('<i class="fas fa-exclamation-triangle"></i> No Classes Found', 'The AI could not confidently identify a list of classes. You can manually enter them using the fields below or switch to the Manual Selection tab.');
                    // Fallback: render an empty slot
                    ocrClasses = [];
                    localStorage.setItem('ocrClasses', JSON.stringify(ocrClasses));
                    renderClassInputs('ocr', ocrClasses);
                }

            } catch (error) {
                console.error("OCR API Call Failed:", error);
                ocrOutput.textContent = `Error processing image: ${error.message}. Please try the manual entry tab instead.`;
                showModal('<i class="fas fa-times-circle"></i> OCR Failed', `There was an error communicating with the recognition service: ${error.message}. Please use the Manual Selection tab.`);
            } finally {
                // Restore Button State
                ocrButton.innerHTML = '<i class="fas fa-magic mr-2"></i> Start OCR and Parse';
                ocrButton.disabled = false;
            }
        }
        
        // 5. Submission Logic (Updated to use dynamic inputs and local storage)
        function sendEmail(source) {
            if (!validateStudentInfo()) return;
            
            // 1. Gather Student Info
            const studentName = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            
            const selectedClasses = source === 'manual' ? manualClasses : ocrClasses;

            if (selectedClasses.length === 0 || selectedClasses.every(c => c.name.trim() === '')) {
                 showModal('<i class="fas fa-exclamation-triangle"></i> Empty Submission', 'The class list is empty. Please enter your requested courses before submitting.');
                 return;
            }
            
            let classList = selectedClasses
                .filter(c => c.name.trim() !== '') // Filter out empty slots
                .map((c, index) => `${index + 1}. ${c.name}`)
                .join('\n');

            let emailBody = `--- STUDENT SUBMISSION DETAILS ---\n`;
            emailBody += `Recipient (Counselor Email): ${COUNSELOR_EMAIL_HARDCODED}\n`;
            emailBody += `Student Name: ${studentName}\n`;
            emailBody += `Student ID/Grade: ${studentId}\n`;
            emailBody += `Submission Source: ${source === 'ocr' ? 'OCR Upload & Correction' : 'Manual Selection'}\n\n`;
            
            emailBody += "--- NEXT YEAR COURSE REQUESTS ---\n";
            emailBody += classList + "\n\n";

            if (source === 'ocr') {
                emailBody += "--- RAW OCR TEXT FOR REFERENCE ---\n";
                emailBody += document.getElementById("ocr-output").textContent + "\n";
                
                showModal(
                    '<i class="fas fa-lock"></i> Back-end Service Required for Submission',
                    `The complete data (Student Info, Next Year's Classes, and OCR context) is ready and previewed below. To send this securely, a custom back-end endpoint is required. Data is ONLY previewed here.`
                );
            } else {
                 showModal(
                    '<i class="fas fa-lock"></i> Back-end Service Required for Submission',
                    `The complete data (Student Info and Next Year's Classes) is ready and previewed below. To send this securely, a custom back-end endpoint is required. Data is ONLY previewed here.`
                );
            }
            
            // Update the preview
            document.getElementById("email-preview-content").textContent = emailBody;
        }

        // Initialize the app on page load
        window.onload = function() {
            // Ensure the Student Info tab is active by default
            openTab('student-info', document.getElementById('tab-info-btn'));
            
            // Initialize the manual inputs (will call renderClassInputs)
            renderClassInputs('manual', manualClasses);
            
            // Initialize the OCR inputs (will call renderClassInputs)
            renderClassInputs('ocr', ocrClasses);
        };
    </script>

</body>
</html>
