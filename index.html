import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Mail, Upload, List, User, CheckCircle, RotateCcw } from 'lucide-react';

// --- CONFIGURATION ---
// FORMSPREE ENDPOINT: This URL is used to submit the form data to your email address.
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xzznvqld';
// --- END CONFIGURATION ---


// --- UTILITY FUNCTIONS ---

/**
 * Converts a File object to a Base64 encoded string.
 * This is necessary to send the image/PDF content to the Gemini API.
 */
const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
        if (!file) {
            reject(new Error("No file provided."));
            return;
        }
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); // Remove the data URI prefix
        reader.onerror = error => reject(error);
    });
};

/**
 * Utility function to handle API fetching with exponential backoff.
 */
const fetchWithExponentialBackoff = async (url, options, maxRetries = 5) => {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) {
                return await response.json();
            }
            if (response.status === 429 && attempt < maxRetries - 1) {
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                await new Promise(res => setTimeout(res, delay));
                continue;
            }
            throw new Error(`API request failed with status: ${response.status} ${response.statusText}`);
        } catch (error) {
            if (attempt === maxRetries - 1) throw error;
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            await new Promise(res => setTimeout(res, delay));
        }
    }
};


// --- DATA STRUCTURES EXTRACTED FROM PDF ---
// This data is pre-processed from the 2025-2026 Choice Cards (1) (1).pdf
const COURSE_DATA = {
    '9th Grade': {
        ENGLISH: ["English, Grade 9", "English, Grade 9, Adv Level"],
        'SOCIAL STUDIES': ["World History: 1500-Pres, Gr 9", "World History, AP*"],
        SCIENCE: ["Biology", "Biology, Advanced Level*", "Physical Science"],
        MATHEMATICS: ["Geometry w/ Data Analysis", "Geometry w/ Data Analysis, Advanced*"],
        'WORLD LANGUAGES': ["Spanish 1", "Spanish 2 (ONLY for those who took Spanish 1 in 8th grade)"],
        'FINE ARTS': ["Color Guard*/**(Fall Only)", "Concert Band (Spring)*/**", "Concert Chorus", "Instrumental Tech*/**", "Journalism 1***", "Marching Band (Fall)*/**", "Theatre, Theatre I*", "Visual Arts I*", "Vocal Tech"],
        'CAREER/TECHNICAL': ["Business Software Applications I* (CP-A)", "Civil Air Patrol I", "Education and Training Foundations*(CP-A)", "Engineering Essentials (CP-A)*", "Exploring Computer Science (CP-A)", "Family and Consumer Science", "Foundations of Health Services*", "Fundamentals of Agriscience (CP-A)", "Intro to Law and American Legal Systems(CP-A)", "Introduction to Manufacturing/Workforce Readiness (CP-A)*", "Sports and Entertainment Marketing Fund"],
        ELECTIVES: ["ACT Prep (1 sem)", "Career Preparedness-A (1 sem)", "Driver and Traffic Safety Education* (1 sem)", "eSports", "Health Education (1 sem)", "Yearbook***", "PE/ATHLETICS FOR FEMALES", "PE/ATHLETICS FOR MALES", "VIRTUAL/ACCESS", "ZERO PERIOD POSSIBILITIES", "Academic Guide Link"],
    },
    '10th Grade': {
        ENGLISH: ["AP Seminar", "English, Grade 10", "English, Grade 10, Adv Level"],
        'SOCIAL STUDIES': ["United States History I: Gr 10", "United States History I: Adv Gr 10*", "UNITED STATES HISTORY I (HIS 201) / UNITED STATES HISTORY II (HIS 202)"],
        SCIENCE: ["Biology", "Chemistry*", "Chemistry, Advanced Level*", "Physical Science"],
        MATHEMATICS: ["Algebra I w/ Probability", "Algebra II w/Statistics, Advanced*", "Algebra I w/ Probability LAB (Elective class- does not count as a math)"],
        'WORLD LANGUAGES': ["Spanish 1", "Spanish 2", "Spanish 3"],
        'FINE ARTS': ["Chamber Choir*/**", "Color Guard*/** (Fall Only)", "Concert Band (Spring)*/**", "Concert Chorus", "Ensemble*/**(Girls Only)", "Guitar I (1 sem)*", "Instrumental Tech */**", "Journalism 1***", "Marching Band (Fall)*/**", "Performers (Boys Only)*/**", "Theatre, Theatre I", "Visual Arts I*", "Visual Arts II*", "Vocal Tech"],
        'CAREER/TECHNICAL': ["Archit. Computer Aided Design */****(1 Sem)", "Business Software Applications I* (CP-A)", "Business Software Applications II", "Civil Air Patrol I", "Civil Air Patrol II", "Computer Aided Design*/**** (1 Sem)", "Computer Science Principles, AP*", "Cybersecurity- PLTW*", "Education and Training Foundations* (CP-A)", "Engineering Essentials (CP-A)*", "Exploring Computer Science (CP-A)", "Family and Consumer Science", "Fundamentals of Agriscience* (CP-A)", "Intermediate Agriscience", "Intro to Law and American Legal Systems (CP-A)", "Introduction to Engineering Design -PLTW*/****", "Introduction to Manufacturing/Workforce Readiness(CP-A", "Marketing Principles* /****(CP-A)", "Personal Finance*", "Sports and Entertainment Marketing Fund*", "Teaching I- Elementary*", "Teaching I- Secondary*", "Therapeutic Services"],
        ELECTIVES: ["ACT Prep (1 sem)", "AP Prep", "AP Research", "Driver and Traffic Safety Education (1 sem)", "eSports", "Health Education (1 sem)", "Personal Fitness (if completed PE)", "Psychology, AP*/****", "Survey of the New Testament ****(Spring)", "Survey of the Old Testament ****(Fall)", "Yearbook***", "PE/ATHLETICS FOR FEMALES", "PE/ATHLETICS FOR MALES", "VIRTUAL/ACCESS", "ZERO PERIOD POSSIBILITIES", "SUMMER SCHOOL OPTIONS"],
    },
    '11th Grade': {
        ENGLISH: ["English, Grade 11", "English, Language and Comp, AP*/****"],
        'SOCIAL STUDIES': ["United States History II: Gr 11", "United States History, AP*", "UNITED STATES HISTORY I (HIS 201) / UNITED STATES HISTORY II (HIS 202)"],
        SCIENCE: ["Biology, AP */****", "Chemistry, AP*/**** (2 Periods with Lab)", "Chemistry*", "Computer Science A, AP*", "Computer Science Principles, AP*", "Cybersecurity-PLTW*", "Earth and Space Science", "Environmental Science", "Environmental Science, AP", "Forensic Science & Crime Sc Invest*", "Human Anatomy and Physiology, Adv*/****", "Human Body Struct. & Functions*", "Introduction to Computer Science- TEALS*", "Physics, Advanced*", "Physics, AP*", "Principles of Engineering*"],
        MATHEMATICS: ["Algebra II with Statistics", "Precalculus*/****", "Precalculus, AP*/****", "MATH LAB ELECTIVE / Algebra II with Statistics Lab"],
        'WORLD LANGUAGES': ["Spanish 1", "Spanish 2", "Spanish 3", "Spanish 4"],
        'FINE ARTS': ["Chamber Choir*/**", "Color Guard*/** (Fall Only)", "Concert Band (Spring)*/**", "Concert Chorus *", "Ensemble*/**(Girls Only)", "Guitar I or II (1 sem)*", "Instrumental Tech */**", "Journalism 1***", "Marching Band (Fall)*/**", "Music Theory, AP*/***", "Performers*/**", "Studio Art*/**", "Theatre, Theatre I*", "Visual Arts I*", "Visual Arts II*", "Visual Arts III", "Vocal Tech"],
        'CAREER/TECHNICAL': ["Advanced Agriscience**", "Archit. Computer Aided Design */****(1 Sem)", "Business Software Applications I (CP-A)", "Business Software Applications II*", "Civil Air Patrol I", "Civil Air Patrol II", "Civil Air Patrol III", "Computer Aided Design*/**** (1 Sem", "Computer Science A, AP*", "Computer Science Principles, AP", "Cooperative Ed WBL (1 Hr)*", "Cooperative Ed WBL (2 Hrs)*", "CTE Lab in AFNR/ Landscaping", "CTE Lab in BMA*/***", "CTE Lab in Education and Training", "CTE Lab in Finance*/***", "CTE Lab in Health Science", "Cybersecurity- PLTW*", "Diagnostic Services", "Digital Media Design*", "Education and Training Foundations (CP-A)*", "Engineering Essentials (CP-A)*", "Family and Consumer Science", "Forensic Science and Crime Sc Invest*", "Foundations of Health Science", "Fundamentals of Agriscience (CP-A)", "Human Body Struct. & Funct.*", "Intermediate Agriscience*", "Intro to Computer Science- TEALS*", "Intro to Law and American Legal Systems", "Introduction to Engineering Design- PLTW*/****", "Introduction to Manufacturing/Workforce Readiness (CP-A)", "Marketing Principles*/****(CP-A)", "Personal Finance", "Principles of Engineering-PLTW*", "Sports and Entertainment Marketing Fund", "Sports Medicine Fundamentals*", "Teaching I- Elementary*", "Teaching I- Secondary*", "Teaching II*", "Therapeutic Services"],
        ELECTIVES: ["ACT Prep (1 sem)", "AP Prep", "AP Research", "Driver and Traffic Safety Education (1 sem)", "eSports", "Health Education (1 sem)", "IRC Peer Aide***", "Personal Fitness (if completed PE)", "Psychology, AP*/****", "Survey of the New Testament ****(Spring)", "Survey of the Old Testament ****(Fall)", "Yearbook***", "PE/ATHLETICS FOR FEMALES", "PE/ATHLETICS FOR MALES", "VIRTUAL/ACCESS", "ZERO PERIOD POSSIBILITIES", "SUMMER SCHOOL OPTIONS"],
    },
    '12th Grade': {
        ENGLISH: ["English, Grade 12", "English, Literature and Comp, AP */****"],
        'SOCIAL STUDIES': ["Economics CP-B (1 sem)", "United States Gov (1 sem)", "Economics CP-B, AP (1 sem)*", "United States Gov and Politics, AP (1 sem)*"],
        SCIENCE: ["Biology, AP */****", "Chemistry, AP*/**** (2 Periods with Lab)", "Chemistry*", "Computer Science A, AP*", "Computer Science Principles, AP*", "Cybersecurity-PLTW*", "Earth and Space Science", "Environmental Science", "Environmental Science, AP*", "Forensic Science & Crime Sc Invest*", "Human Anatomy and Physiology, Adv*/****", "Human Body Struct. & Functions*", "Introduction to Computer Science- TEALS*", "Physics, Advanced*", "Physics, AP*", "Principles of Engineering*"],
        MATHEMATICS: ["Calculus AB, AP****", "Computer Science Principles, AP*", "Intro to Computer Science- TEALS*", "Introduction to Engineering Design*/****", "Mathematical Modeling", "Precalculus, AP*/****", "Precalculus*/****", "Statistics, AP*/****"],
        'WORLD LANGUAGES': ["Spanish 1", "Spanish 2", "Spanish 3", "Spanish 4"],
        'FINE ARTS': ["2-D Art Design, AP*/**", "Chamber Choir*/**", "Color Guard*/** (Fall Only)", "Concert Band (Spring)*/**", "Concert Chorus*", "Ensemble*/** (Girls Only)", "Guitar I or II (1 sem)*", "Instrumental Tech*/**", "Journalism 1***", "Marching Band (Fall)*/**", "Music Theory, AP*", "Performers*/**", "Studio Art*/**", "Theatre, Theatre*", "Visual Arts I", "Visual Arts II*", "Visual Arts III*", "Visual Arts IV", "Vocal Tech"],
        'CAREER/TECHNICAL': ["Advanced Agriscience", "Applications of Engineering and Technology", "Applied Agriscience*", "Archit. Computer Aided Design */****(1 Sem)", "Banking and Financial Services", "Business Software Applications I* (CP-A)", "Business Software Applications II*", "Civil Air Patrol I", "Civil Air Patrol II", "Civil Air Patrol III", "Civil Air Patrol IV", "Computer Science A, AP*", "Computer Science Principles, AP*", "Cooperative Ed WBL (1 Hr)*", "Cooperative Ed WBL (2 Hrs)*", "Cooperative Ed WBL (3 Hrs)*", "CTE Lab in AFNR/ Landscaping", "CTE Lab in BMA */***", "CTE Lab in Education and Training", "CTE Lab in Finance*/***", "CTE Lab in Health Science", "Cybersecurity- PLTW*", "Digital Media Design*", "Education and Train. Internship* (2 Hrs)", "Education and Training Foundations* (CP-A)", "Engineering Essentials (CP-A)", "Family and Consumer Science", "Forensic Science & Crime Sc Invest", "Fundamentals of Agriscience* (CP-A)", "Health Science Internship (2 hours)*/***/****", "Human Body Struct. & Funct.*", "Intermediate Agriscience*", "Intro to Computer Science- TEALS*", "Intro to Law and American Legal Systems (CP-A)", "Introduction to Engineering Design- PLTW*/****", "Introduction to Manufacturing/Workforce Readiness (CP-A)*", "Marketing Principles*/**** (CP-A)", "Personal Finance*", "Pharmacy Technician*", "Principles of Engineering- PLTW*", "Sports and Entertainment Marketing Fund", "Sports Medicine Fundamentals", "Teaching I- Elementary*", "Teaching I- Secondary*", "Teaching II*"],
        ELECTIVES: ["ACT Prep (1 sem)", "AP Prep", "AP Research", "Driver and Traffic Safety Education (1 sem)", "eSports", "Health Education (1 sem)", "IRC Peer Aide***", "Personal Fitness (if completed PE)", "Psychology, AP*/****", "Survey of the New Testament ****(Spring)", "Survey of the Old Testament ****(Fall)", "Yearbook***", "PE/ATHLETICS FOR FEMALES", "PE/ATHLETICS FOR MALES", "Non-Credit Course (Needs Admin. approval)", "VIRTUAL/ACCESS", "ZERO PERIOD POSSIBILITIES", "SUMMER SCHOOL OPTIONS"],
    }
};

const GRADE_LEVELS = ['9th Grade', '10th Grade', '11th Grade', '12th Grade'];
const FOUR_YEAR_SUBJECTS = ["English", "Social Studies", "Math", "Science", "Health/LIFE Physical Education/Electives", "Career Preparedness / Electives", "Career Tech and/or World Language and/or Arts/ Electives"];

// Main Application Component
const App = () => {
    const [studentName, setStudentName] = useState('');
    const [gradeLevel, setGradeLevel] = useState(GRADE_LEVELS[0]);
    const [activeTab, setActiveTab] = useState('manual'); // 'manual' or 'ocr'
    const [selectedFile, setSelectedFile] = useState(null);
    const [ocrResult, setOcrResult] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [selectedCourses, setSelectedCourses] = useState({
        English: '', Math: '', 'Social Studies': '', Science: '',
        Elective1: '', Elective2: '', Elective3: '', AltElective1: '', AltElective2: ''
    });

    const initialFourYearPlan = useMemo(() => {
        const plan = {};
        FOUR_YEAR_SUBJECTS.forEach(subject => {
            plan[subject] = { '9th Grade': '', '10th Grade': '', '11th Grade': '', '12th Grade': '', 'Summer School': '' };
        });
        return plan;
    }, []);

    const [fourYearPlan, setFourYearPlan] = useState(initialFourYearPlan);

    // --- Course Data Memoization ---
    const availableCourses = useMemo(() => COURSE_DATA[gradeLevel] || {}, [gradeLevel]);

    // --- Handlers ---

    const handleCourseSelect = (key, value) => {
        setSelectedCourses(prev => ({ ...prev, [key]: value }));
        setOcrResult(null); // Clear OCR result if manual changes are made
    };

    const handleFileChange = (event) => {
        setSelectedFile(event.target.files[0]);
        setOcrResult(null);
        setMessage('');
    };

    /**
     * Attempts to map the extracted course names (strings) from the LLM response
     * into the structured state object (selectedCourses).
     */
    const mapExtractedCourses = (extractedCourses) => {
        const mapped = {};
        // Use a set to get all unique course names across all categories for the current grade
        const allCourseNames = new Set(Object.values(COURSE_DATA[gradeLevel]).flat());
        
        let coreKeys = ['English', 'Math', 'Social Studies', 'Science'];
        let electiveKeys = ['Elective1', 'Elective2', 'Elective3', 'AltElective1', 'AltElective2'];

        // Simple mapping based on subject type and slot availability
        extractedCourses.forEach(course => {
            // Check if the extracted course is a valid course name in the data set
            if (allCourseNames.has(course)) {
                
                // 1. Try to map to core subjects
                if (coreKeys.length > 0) {
                    const subject = coreKeys.shift();
                    mapped[subject] = course;
                } 
                // 2. If core slots are filled or course doesn't fit, map to electives
                else if (electiveKeys.length > 0) {
                    const electiveKey = electiveKeys.shift();
                    mapped[electiveKey] = course;
                }
            }
        });

        setSelectedCourses(prev => ({ 
            ...prev, 
            ...mapped 
        }));
    };

    /**
     * Calls the Gemini API to perform OCR and structured data extraction.
     */
    const handleOCRSubmit = async () => {
        if (!selectedFile) {
            setMessage('Please select a PDF or image file first.');
            return;
        }

        setIsLoading(true);
        setMessage(`Processing ${selectedFile.name} with AI...`);
        
        try {
            const base64Data = await fileToBase64(selectedFile);
            
            const systemPrompt = `You are a precise data extraction tool for school counseling. Analyze the uploaded school registration form (which is for ${gradeLevel} students). 
                                  Your task is to extract only the courses explicitly selected or written by the student for the upcoming school year. 
                                  Return the output as a single JSON object. The keys must be 'selectedCourses' and the value must be an array of strings containing only the extracted course names. 
                                  Do not include any preamble, commentary, or markdown formatting outside of the JSON object itself.`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: `Extract the selected courses from this image/document. The student is enrolling in the ${gradeLevel} curriculum.` },
                        {
                            inlineData: {
                                mimeType: selectedFile.type,
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            selectedCourses: {
                                type: "ARRAY",
                                description: "List of all selected course names as strings.",
                                items: { type: "STRING" }
                            }
                        }
                    }
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            // --- API KEY IMPLEMENTATION ---
            // Your provided key is inserted here to enable the OCR feature.
            const apiKey = "AIzaSyD73nlmmDQlsWo-2mxUvszjXgMtQ7VMu64"; 
            // -----------------------------

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const response = await fetchWithExponentialBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const jsonString = response.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!jsonString) throw new Error("AI failed to return structured course data.");

            const parsedJson = JSON.parse(jsonString);
            const extractedCourses = parsedJson.selectedCourses || [];

            if (extractedCourses.length > 0) {
                mapExtractedCourses(extractedCourses);
                setMessage(`Successfully extracted ${extractedCourses.length} courses. Please review the selections below.`);
                setOcrResult({ success: true });
            } else {
                setMessage('The AI could not find any selected courses in the document. Please try a clearer image or use manual entry.');
                setOcrResult({ success: false });
            }

        } catch (error) {
            console.error("OCR/API Error:", error);
            setMessage('Error during course extraction. Please check the file and try again. Use manual entry if the problem persists.');
            setOcrResult({ success: false });
        } finally {
            setIsLoading(false);
        }
    };

    const handleFourYearPlanChange = (subject, year, course) => {
        setFourYearPlan(prev => ({
            ...prev,
            [subject]: {
                ...prev[subject],
                [year]: course
            }
        }));
    };

    /**
     * Structures the application state into a flattened object for Formspree submission.
     */
    const formatDataForFormspree = () => {
        const formData = {
            'student-name': studentName,
            'current-grade': gradeLevel,
            'submission-date': new Date().toLocaleString(),
        };

        // 1. Next Year's Courses
        let nextYearCoursesSummary = '2025-2026 Courses:\n';
        Object.entries(selectedCourses).forEach(([key, value]) => {
            if (value) {
                // Use a standard field name for Formspree
                formData[`next-year-course-${key.replace(' ', '-').toLowerCase()}`] = value;
                nextYearCoursesSummary += `  - ${key}: ${value}\n`;
            }
        });

        // 2. Four Year Plan
        let planSummary = 'Four-Year Plan Overview:\n';
        FOUR_YEAR_SUBJECTS.forEach(subject => {
            const safeSubjectKey = subject.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            planSummary += `${subject}:\n`;
            
            const currentSubjectPlan = fourYearPlan[subject];
            if (currentSubjectPlan) {
                Object.entries(currentSubjectPlan).forEach(([year, course]) => {
                    // Use a unique field name for each cell in the 4-year plan grid
                    const safeYearKey = year.replace(' ', '-').toLowerCase();
                    if (course) {
                        formData[`plan-${safeSubjectKey}-${safeYearKey}`] = course;
                    } else {
                        // Include empty fields so the structure is consistent in the email
                        formData[`plan-${safeSubjectKey}-${safeYearKey}`] = '[Not Selected]';
                    }
                    planSummary += `  - ${year}: ${course || '[Not Selected]'}\n`;
                });
            }
        });
        
        // Include a readable summary text field for the email body in Formspree
        formData['full-course-plan-summary'] = `*** STUDENT INFORMATION ***\nName: ${studentName}\nGrade Level: ${gradeLevel}\n\n*** COURSE SELECTIONS ***\n${nextYearCoursesSummary}\n\n*** FOUR-YEAR PLAN OVERVIEW ***\n${planSummary}`;


        return formData;
    };


    /**
     * Sends the data to the Formspree endpoint.
     */
    const handleSubmit = async () => {
        if (!studentName) {
            console.error('Submission Error: Please enter the student\'s name before submitting.');
            setMessage('Please enter the student\'s name before submitting.');
            return;
        }

        setIsLoading(true);
        setMessage('Submitting course plan...');

        const formData = formatDataForFormspree();

        try {
            const response = await fetch(FORMSPREE_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                setMessage('Success! Your course plan has been submitted to the counselor. You can now close this page.');
            } else {
                // Try to get error message from Formspree response
                const errorData = await response.json();
                const errorMessage = errorData.error || 'Unknown Formspree error.';
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Form Submission Error:', error);
            setMessage(`Submission Failed: ${error.message || 'Could not connect to the submission service.'} Please double-check your Formspree code and network connection.`);
        } finally {
            setIsLoading(false);
        }
    };

    // --- Components ---

    const StudentInfo = () => (
        <div className="p-4 bg-white rounded-lg shadow-md border border-indigo-100">
            <h2 className="text-xl font-bold text-indigo-700 mb-4 flex items-center">
                <User className="w-5 h-5 mr-2" /> Student Information
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Student Name</label>
                    <input
                        type="text"
                        value={studentName}
                        onChange={(e) => setStudentName(e.target.value)}
                        placeholder="Enter Student Name"
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Current Grade Level</label>
                    <select
                        value={gradeLevel}
                        onChange={(e) => {
                            setGradeLevel(e.target.value);
                            setOcrResult(null); // Reset OCR context when grade changes
                        }}
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white"
                    >
                        {GRADE_LEVELS.map(g => (
                            <option key={g} value={g}>{g}</option>
                        ))}
                    </select>
                </div>
            </div>
        </div>
    );

    const CourseSelection = () => (
        <div className="bg-white rounded-lg shadow-md border border-indigo-100 mt-6">
            <div className="flex border-b border-indigo-200">
                <button
                    onClick={() => setActiveTab('manual')}
                    className={`flex-1 py-3 px-4 text-center text-sm font-medium transition-colors duration-200 ${
                        activeTab === 'manual'
                            ? 'bg-indigo-600 text-white rounded-tl-lg'
                            : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'
                    } flex items-center justify-center`}
                >
                    <List className="w-4 h-4 mr-2" /> Manual Selection
                </button>
                <button
                    onClick={() => setActiveTab('ocr')}
                    className={`flex-1 py-3 px-4 text-center text-sm font-medium transition-colors duration-200 ${
                        activeTab === 'ocr'
                            ? 'bg-indigo-600 text-white rounded-tr-lg'
                            : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'
                    } flex items-center justify-center`}
                >
                    <Upload className="w-4 h-4 mr-2" /> OCR / Upload Card
                </button>
            </div>

            <div className="p-4">
                <h2 className="text-xl font-bold text-indigo-700 mb-4">
                    2025-2026 Course Selection (Next Year)
                </h2>

                {activeTab === 'ocr' ? (
                    <OcrSection />
                ) : (
                    <ManualSelectionSection />
                )}
            </div>
        </div>
    );

    const ManualSelectionSection = () => (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {Object.entries(selectedCourses).map(([key]) => {
                // Determine the subject category in COURSE_DATA
                const subjectKey = ['English', 'Math', 'Science', 'Social Studies'].includes(key) ? key.toUpperCase() : 'ELECTIVES';
                
                // Use a Set to ensure course options are unique before converting back to an array
                const rawCourses = availableCourses[subjectKey] || availableCourses['ELECTIVES'] || [];
                const courseOptions = Array.from(new Set(rawCourses));


                return (
                    <div key={key}>
                        <label className="block text-sm font-medium text-gray-700">{key}</label>
                        <select
                            value={selectedCourses[key]}
                            onChange={(e) => handleCourseSelect(key, e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white"
                        >
                            <option value="">-- Select a Course --</option>
                            {courseOptions.map(course => (
                                <option key={course} value={course}>{course}</option>
                            ))}
                        </select>
                    </div>
                );
            })}
        </div>
    );

    const OcrSection = () => (
        <div className="space-y-4">
            <p className="text-sm text-gray-600">
                Upload a picture or PDF of the completed **{gradeLevel} Registration Form**. The system will use AI (Gemini API) to extract and auto-fill your course selections below.
            </p>
            <div className="flex items-center space-x-4">
                <input
                    type="file"
                    accept=".pdf,.jpg,.jpeg,.png"
                    onChange={handleFileChange}
                    className="flex-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                />
                <button
                    onClick={handleOCRSubmit}
                    disabled={!selectedFile || isLoading}
                    className={`px-4 py-2 rounded-lg text-white font-semibold transition-colors flex items-center justify-center ${
                        selectedFile && !isLoading ? 'bg-indigo-600 hover:bg-indigo-700 shadow-md' : 'bg-gray-400 cursor-not-allowed'
                    }`}
                >
                    {isLoading ? (
                        <>
                            <RotateCcw className="w-4 h-4 mr-2 animate-spin" /> Processing...
                        </>
                    ) : (
                        <>
                            <CheckCircle className="w-4 h-4 mr-2" /> Extract Courses
                        </>
                    )}
                </button>
            </div>
            {message && (
                <div className={`p-3 text-sm rounded-lg ${ocrResult?.success ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                    {message}
                </div>
            )}

            {/* Display extracted/mapped courses for confirmation */}
            <h3 className="font-semibold text-gray-700 pt-2">Mapped Courses (Review & Edit):</h3>
            <ManualSelectionSection />
        </div>
    );

    const FourYearPlan = () => {
        const years = ['9th Grade', '10th Grade', '11th Grade', '12th Grade', 'Summer School'];
        
        return (
            <div className="bg-white rounded-lg shadow-md border border-indigo-100 mt-6 p-4">
                <h2 className="text-xl font-bold text-indigo-700 mb-4">
                    <List className="w-5 h-5 mr-2 inline-block" /> Four Year Plan Overview
                </h2>
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-indigo-50">
                            <tr>
                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sticky left-0 bg-indigo-50 z-10 w-48">
                                    Subject
                                </th>
                                {years.map(year => (
                                    <th key={year} className="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-32">
                                        {year}
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {FOUR_YEAR_SUBJECTS.map(subject => (
                                <tr key={subject}>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-indigo-600 sticky left-0 bg-white w-48 border-r">
                                        {subject.split('(')[0].trim()}
                                    </td>
                                    {years.map(year => {
                                        let coreCourses = ['N/A']; // Default for years with no data or summer school
                                        
                                        if (COURSE_DATA[year]) {
                                            // Get courses from core subjects for this year
                                            const rawCoreCourses = [
                                                ...(COURSE_DATA[year].ENGLISH || []),
                                                ...(COURSE_DATA[year].MATHEMATICS || []),
                                                ...(COURSE_DATA[year].SCIENCE || []),
                                                ...(COURSE_DATA[year]['SOCIAL STUDIES'] || []),
                                                'Other Elective'
                                            ].filter(Boolean); // Filter out any falsey values
                                            
                                            // Ensure unique keys for options
                                            coreCourses = Array.from(new Set(rawCoreCourses));
                                        }

                                        return (
                                            <td key={`${subject}-${year}`} className="px-3 py-2">
                                                <select
                                                    value={fourYearPlan[subject][year]}
                                                    onChange={(e) => handleFourYearPlanChange(subject, year, e.target.value)}
                                                    className="w-full text-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-1 border bg-white"
                                                >
                                                    <option value="">- Select -</option>
                                                    {coreCourses.map(course => (
                                                        // Use the course name itself as the key since the list is now unique
                                                        <option key={course} value={course}>{course}</option>
                                                    ))}
                                                </select>
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <p className="text-xs text-gray-500 mt-4">
                    *The course options in the 4-Year Plan are simplified for demonstration; in a live version, these would link to a complete academic catalog.
                </p>
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-8 font-sans">
            <style>{`
                /* Inter font */
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
                body { font-family: 'Inter', sans-serif; }
            `}</style>
            <div className="max-w-4xl mx-auto">
                <header className="text-center mb-8">
                    <h1 className="text-3xl font-extrabold text-indigo-800">Counselor Course Planning Assistant</h1>
                    <p className="text-lg text-gray-600 mt-2">Hartselle High School Course Registration 2025-2026</p>
                </header>

                <StudentInfo />
                <CourseSelection />
                <FourYearPlan />

                <div className="mt-8 pt-6 border-t border-indigo-200 flex flex-col items-center">
                    <button
                        onClick={handleSubmit}
                        disabled={!studentName || isLoading}
                        className={`px-6 py-3 rounded-lg text-white font-bold transition-transform transform ${
                            studentName && !isLoading ? 'bg-green-600 hover:bg-green-700 shadow-lg hover:scale-[1.02]' : 'bg-gray-400 cursor-not-allowed'
                        } flex items-center`}
                    >
                        {isLoading ? (
                             <>
                                <RotateCcw className="w-5 h-5 mr-2 animate-spin" /> Submitting...
                            </>
                        ) : (
                            <>
                                <Mail className="w-5 h-5 mr-2" />
                                Submit Course Plan
                            </>
                        )}
                    </button>
                </div>
                
                <div className="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg text-sm">
                    <p className="font-semibold">Important Notes:</p>
                    <p>1. **OCR Live:** The **OCR/Upload Card** feature uses the **Gemini API** for multimodal (image/PDF) analysis and course extraction.</p>
                    <p>2. **Submission:** The "Submit Course Plan" button now sends all the data directly to your Formspree endpoint (`https://formspree.io/f/xzznvqld`).</p>
                </div>
            </div>
        </div>
    );
};

export default App;
